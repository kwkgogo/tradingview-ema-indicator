//@version=6
indicator("EMA 9/21/50", overlay=true, precision=2, format=format.price, max_labels_count=500)

// ===== Inputs =====
src = input.source(close, "Source", group="Source")
showRibbon = input.bool(true,  "Shade 20 vs 50 Distance", group="Visuals")
showShapes = input.bool(true,  "Show Cross Labels",       group="Visuals")

// ===== Colors =====
const color COL9    = color.teal
const color COL21   = color.orange
const color COL50   = color.purple
const color COL_GLD = color.green
const color COL_DTH = color.red
const int   TR_FILL = 85

// ===== MAs (固定周期：9/21/50) =====
ema9_raw  = ta.ema(src, 9)
ema21_raw = ta.ema(src, 21)
ema50_raw = ta.ema(src, 50)

// 为了与 SMA 脚本“未形成=不显示”的语义一致：前 len-1 根返回 na
ema9  = bar_index >= 9  - 1 ? ema9_raw  : na
ema21 = bar_index >= 21 - 1 ? ema21_raw : na
ema50 = bar_index >= 50 - 1 ? ema50_raw : na

// ===== Plots =====
p9  = plot(ema9,  "EMA 9",  color=COL9,  linewidth=1, linestyle=plot.linestyle_dashed)
p21 = plot(ema21, "EMA 21", color=COL21, linewidth=1)
p50 = plot(ema50, "EMA 50", color=COL50, linewidth=2)

// Ribbon（对齐你原脚本逻辑：用“快 vs 中”着色）
fill(p9, p21, color = showRibbon and not na(ema9) and not na(ema21)
                 ? color.new((ema9 >= ema21 ? COL9 : COL21), TR_FILL) : na)

// ===== Cross logic =====
co_9_21   = ta.crossover(ema9,  ema21)
cu_9_21   = ta.crossunder(ema9,  ema21)
co_21_50  = ta.crossover(ema21, ema50)
cu_21_50  = ta.crossunder(ema21, ema50)

// ===== Labels =====
if showShapes and co_9_21
    label.new(bar_index, na, xloc=xloc.bar_index, yloc=yloc.belowbar, text="9 cross over 21",  style=label.style_label_up,   color=COL9,  textcolor=color.white, size=size.tiny)
if showShapes and cu_9_21
    label.new(bar_index, na, xloc=xloc.bar_index, yloc=yloc.abovebar, text="9 cross under 21", style=label.style_label_down, color=COL21, textcolor=color.white, size=size.tiny)
if showShapes and co_21_50
    label.new(bar_index, na, xloc=xloc.bar_index, yloc=yloc.belowbar, text="21 cross over 50", style=label.style_label_up,   color=COL_GLD, textcolor=color.white, size=size.tiny)
if showShapes and cu_21_50
    label.new(bar_index, na, xloc=xloc.bar_index, yloc=yloc.abovebar, text="21 cross under 50",style=label.style_label_down, color=COL_DTH, textcolor=color.white, size=size.tiny)

// ===== Alerts =====
x_9_21   = ta.cross(ema9,  ema21)
x_21_50  = ta.cross(ema21, ema50)
x_px_9   = ta.cross(src,   ema9)
x_px_21  = ta.cross(src,   ema21)
x_px_50  = ta.cross(src,   ema50)
x_any    = x_9_21 or x_21_50 or x_px_9 or x_px_21 or x_px_50

alertcondition(x_9_21,  "EMA9 crosses EMA21",  "⚠️ ATTENTION!!! EMA9 crossed EMA21")
alertcondition(x_21_50, "EMA21 crosses EMA50", "⚠️ ATTENTION!!! EMA21 crossed EMA50")
alertcondition(x_px_9,  "Price crosses EMA9",  "⚠️ ATTENTION!!! Price crossed EMA9")
alertcondition(x_px_21, "Price crosses EMA21", "⚠️ ATTENTION!!! Price crossed EMA21")
alertcondition(x_px_50, "Price crosses EMA50", "⚠️ ATTENTION!!! Price crossed EMA50")
alertcondition(x_any,   "ANY: EMA/Price crosses (9/21/50)", "⚠️ ATTENTION!!! EMA or Price cross detected (9/21/50)")
